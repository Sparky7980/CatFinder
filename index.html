<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js"></script>

<script>
  // Your Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyD1qXZMIjguT3anCpRzo4wJlyBa1MS_b5M",
    authDomain: "nycattracker.firebaseapp.com",
    projectId: "nycattracker",
    storageBucket: "nycattracker.firebasestorage.app",
    messagingSenderId: "145737349172",
    appId: "1:145737349172:web:c52b3d3cbd5b26460ef261"
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const map = L.map('map').setView([37.7749, -122.4194], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  const markers = L.layerGroup().addTo(map);

  async function fetchSightings() {
    try {
      const querySnapshot = await db.collection('catSightings').get();
      markers.clearLayers();
      querySnapshot.forEach(doc => {
        const sighting = doc.data();
        const marker = L.marker([sighting.latitude, sighting.longitude]).addTo(markers);
        marker.bindPopup(
          `<strong>${sighting.catName}</strong><br>${sighting.description}<br>${sighting.location}`
        );
      });
    } catch (error) {
      console.error("Failed to fetch sightings", error);
    }
  }

  async function reportSighting() {
    const catName = document.getElementById("catName").value;
    const location = document.getElementById("location").value;
    const description = document.getElementById("description").value;

    if (!catName || !location || !description) {
      alert("Please fill in all fields.");
      return;
    }

    try {
      const newSighting = {
        catName,
        location,
        description,
        latitude: map.getCenter().lat,
        longitude: map.getCenter().lng,
        timestamp: new Date().toISOString()
      };

      await db.collection('catSightings').add(newSighting);
      alert("Sighting reported successfully!");
      fetchSightings();
    } catch (error) {
      console.error("Error reporting sighting", error);
      alert("An error occurred while reporting the sighting.");
    }
  }

  fetchSightings();
  setInterval(fetchSightings, 30000); // Refresh sightings every 30 seconds
</script>
